version: '3.8'

services:
  # Serviço para o Banco de Dados Neo4j
  neo4j:
    image: neo4j:5.15.0-community  # Versão estável com suporte a vetores (5.x ou superior)
    hostname: neo4j
    ports:
      - "7474:7474" # Browser HTTP
      - "7687:7687" # Porta Bolt (usada pela aplicação)
    volumes:
      # Persiste os dados para que você não perca o grafo
      - ./data/neo4j:/data
      # Habilita o uso de índices vetoriais (necessário para o RAG)
      - ./conf/neo4j:/var/lib/neo4j/conf
      # Plugins
      - ./plugins/neo4j:/var/lib/neo4j/plugins
    environment:
      # Variável para aceitar a licença
      - NEO4J_ACCEPT_LICENSE_AGREEMENT=yes
      # Variáveis de Credenciais (Ajuste a senha)
      - NEO4J_AUTH=neo4j/sua_senha_segura 
      # Configurações para o índice vetorial
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*,gds.*
      - NEO4J_server_memory_heap_initial__size=512m
      - NEO4J_server_memory_heap_max__size=1G
    restart: unless-stopped
  
  # Serviço da Aplicação RAG em Python
  rag-app:
    build: . # Usa o Dockerfile no diretório atual
    depends_on:
      - neo4j # Garante que o Neo4j suba primeiro
    environment:
      # Configurações para o Python se conectar ao Neo4j
      # O host é o nome do serviço (neo4j)
      - NEO4J_URI=bolt://neo4j:7687 
      - NEO4J_USERNAME=neo4j
      - NEO4J_PASSWORD=sua_senha_segura # Use a mesma senha acima
      # Variável essencial para o LLM e Embeddings
      - OPENAI_API_KEY=${OPENAI_API_KEY} 
    # Mapeia o diretório de trabalho para facilitar o desenvolvimento
    volumes:
      - .:/app
    # Mantém o container rodando para que você possa executá-lo manualmente
    # ou para que ele não feche após a execução (útil para debug)
    command: ["sleep", "infinity"]